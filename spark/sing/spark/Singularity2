# based on nickjer/singularity-rstudio-spark:latest

BootStrap: localimage
From: spark.img

%labels
  Maintainer Hao Xu
  Spark_Version 2.3.1
  Hadoop_Version 2.7

%help
  preproc CMAQ:
  singularity run spark.img --app preprocCMAQ <spark master host> <input file> <output directory>
  preproc CMAQ2:
  singularity run spark.img --app preprocCMAQ2 <spark master host> <input directory> <output directory>
  preproc Daily Env Data:
  singularity run spark.img --app preprocDailyEnvData <spark master host> <input file> <output directory>
  preproc Per Patient Series Env Data:
  singularity run spark.img --app preprocPerPatSeriesEnvData <spark master host> <input directory> <patient ids file> <fihr files> <environmental files> <start date> <end data> <output directory>
  preproc Per Patient Series Nearest Road Data:
  singularity run spark.img --app preprocPerPatSeriesNearestRoad <spark master host> <input directory> <patient ids file> <fihr files> <nearest road file> <output directory>
  preproc Per Patient Series ACS Data:
  singularity run spark.img --app preprocPerPatSeriesACS <spark master host> <input directory> <patient ids file> <fihr files> <geoid file> <acs file> <output directory>

%apprun preprocCMAQ
  cd /opt/datatrans/spark
  exec python3 src/main/python/runPreprocCMAQ.py /opt/datatrans "$@"

%apprun preprocCMAQ2
  exec python3 src/main/python/preproc_cmaq_2011.py "$@"

%apprun preprocDailyEnvData
  cd /opt/datatrans/spark
  exec python3 src/main/python/runPreprocDailyEnvData.py /opt/datatrans "$@"

%apprun preprocPerPatSeriesEnvData
  cd /opt/datatrans/spark
  exec python3 src/main/python/runPreprocPerPatSeriesEnvData.py /opt/datatrans "$@"

%apprun preprocPerPatSeriesNearestRoad
  cd /opt/datatrans/spark
  exec python3 src/main/python/runPreprocPerPatSeriesNearestRoad.py /opt/datatrans "$@"

%apprun preprocPerPatSeriesACS
  cd /opt/datatrans/spark
  exec python3 src/main/python/runPreprocPerPatSeriesACS.py /opt/datatrans "$@"

%post
  cd /opt
  git clone https://github.com/xu-hao/datatrans
  cd datatrans/spark
  sbt package
  cp -r ~/.ivy2 /opt/datatrans
  
  

